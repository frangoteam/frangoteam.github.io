window.extMarkers=function(){window.svgEditor&&svgEditor.addExtension("Markers",function(e){function t(t,r){var a=t.getAttribute(r);if(!a)return null;var n=a.match(/\(\#(.*)\)/);return n&&2===n.length?e.getElem(n[1]):null}function r(e,t){"\\"!==t.substr(0,1)&&(t="\\textmarker"),console.log("mark set icon "+e,0+t);var r=document.getElementById(e+"_marker"),a=0;$.each(g,function(e,r){return t.indexOf(e)===-1&&void a++}),r.selectedIndex=a}function a(e){if($("#marker_panel").toggle(e),e){var a,n,i=m[0];$.each(u,function(e,l){var o=t(i,"marker-"+l),d=$("#"+l+"_marker");if(o){if(!o.attributes.se_type)return;a="\\"+o.attributes.se_type.textContent,n=a,"\\textmarker"===a?a=o.lastChild.textContent:d.hide()}else a="\\nomarker",n=a,d.hide();d.val(a),r(l,n)})}else console.log("hide panel")}function n(t,r){var a="#ffffff",n="none",i=0,l=e.getElem(t);if(!l&&""!=r&&"\\nomarker"!=r){var o,d=m[0],u=d.getAttribute("stroke"),c=50,b=50,h="0 0 100 100",f=10,k=10,v=10;if(o="\\"===r.substr(0,1)?r.substr(1):"textmarker",g[o]){if(l=s({element:"marker",attr:{id:t,orient:"auto",style:"pointer-events:none",se_type:o}}),"textmarker"!=o){var A=s(g[o]),p=u;"_o"===o.substr(-2)&&(p="none"),A.setAttribute("fill",p),A.setAttribute("stroke",u),A.setAttribute("stroke-width",v),l.appendChild(A)}else{var x=s(g[o]);x.textContent=r;var y=x.getBBox(),C=1,w=y;w.x=0,w.y=0,w.width+=2*C,w.height+=2*C,x.setAttribute("x",C),x.setAttribute("y",w.height-C-y.height/4),x.setAttribute("fill",u),c=w.width/2+C,b=w.height/2+C,h=w.x+" "+w.y+" "+w.width+" "+w.height,f=w.width/10,k=w.height/10;var _=s({element:"rect",attr:{x:w.x,y:w.y,width:w.width,height:w.height,fill:a,stroke:n,"stroke-width":i}});l.setAttribute("orient",0),l.appendChild(_),l.appendChild(x)}return l.setAttribute("viewBox",h),l.setAttribute("markerWidth",f),l.setAttribute("markerHeight",k),l.setAttribute("refX",c),l.setAttribute("refY",b),e.findDefs().appendChild(l),l}}}function i(t){if("line"!==t.tagName)return t;var r=Number(t.getAttribute("x1")),a=Number(t.getAttribute("x2")),n=Number(t.getAttribute("y1")),i=Number(t.getAttribute("y2")),l=t.id,o=" "+(r+a)/2+","+(n+i)/2+" ",d=s({element:"polyline",attr:{points:r+","+n+o+a+","+i,stroke:t.getAttribute("stroke"),"stroke-width":t.getAttribute("stroke-width"),fill:"none",opacity:t.getAttribute("opacity")||1}});$.each(u,function(e,r){var a="marker-"+r,n=t.getAttribute(a);n&&d.setAttribute(a,t.getAttribute(a))});var m=new e.BatchCommand;return m.addSubCommand(new e.RemoveElementCommand(t,t.parentNode)),m.addSubCommand(new e.InsertElementCommand(d)),$(t).after(d).remove(),svgCanvas.clearSelection(),d.id=l,svgCanvas.addToSelection([d]),e.addCommandToHistory(m),d}function l(a,l){var o={start_marker:"start",mid_marker:"mid",end_marker:"end"},d=o[a],s="marker-"+d,u=l,g=m[0],b=t(g,s);if(b&&$(b).remove(),g.removeAttribute(s),""==u&&(u="\\nomarker"),"\\nomarker"==u)return r(d,u),void e.call("changed",m);var a=c+d+"_"+g.id;n(a,u),svgCanvas.changeSelectedAttribute(s,"url(#"+a+")"),"line"===g.tagName&&"mid"==d&&(g=i(g)),e.call("changed",m),r(d,u)}function o(e){var r=e.getAttribute("stroke");$.each(u,function(a,n){var i=t(e,"marker-"+n);if(i&&i.attributes.se_type){var l=i.lastElementChild;if(l){var o=l.getAttribute("fill"),d=l.getAttribute("stroke");o&&"none"!=o&&l.setAttribute("fill",r),d&&"none"!=d&&l.setAttribute("stroke",r)}}})}function d(r){$.each(u,function(a,l){var o=c+l+"_"+r.id,d="marker-"+l,s=t(r,d);if(s&&s.attributes.se_type){var u=r.getAttribute(d);if(u){var g=r.id.length,b=u.substr(-g-1,g);if(r.id!=b){var h=$("#"+l+"_marker").attr("value");n(o,h),svgCanvas.changeSelectedAttribute(d,"url(#"+o+")"),"line"===r.tagName&&"mid"==l&&(r=i(r)),e.call("changed",m)}}}})}var m,s=e.addSvgElementFromJson,u=["start","mid","end"],c="se_marker_",g={nomarker:{label:"&#x2014;"},leftarrow:{element:"path",attr:{d:"M0,50 L100,90 L70,50 L100,10 Z"},label:"&#x25C4;"},rightarrow:{element:"path",attr:{d:"M100,50 L0,90 L30,50 L0,10 Z"},label:"&#x25BA;"},leftpointing:{element:"path",attr:{d:"M50,48 L90,90 M50,52 L90,10"},label:"&#x2009;&#x02C2;"},rightpointing:{element:"path",attr:{d:"M50,48 L10,90 L50,52 L10,10 Z"},label:"&#x2009;&#x003E;"},break:{element:"path",attr:{d:"M50,20 L50,80"},label:"&#x2009;&#x2223;"},mcircle:{element:"circle",attr:{r:30,cx:50,cy:50},label:"&#x2009;&#x25CF;"}};return{name:"Markers",mySetMarker:function(e,t){console.log("in marker selected "+e+" "+t);var r=void 0,a=0;$.each(g,function(e,n){t===a++&&(r=e)}),l(e,"\\"+r)},callback:function(){console.log("marker callback");var e=document.getElementById("start_marker"),t=document.getElementById("mid_marker"),r=document.getElementById("end_marker");$.each(g,function(a,n){if(n.label){var i=document.createElement("option");i.value=n.label,i.innerHTML=n.label,i.setAttribute("style","background-color: rgba(33,33,33,1);color: rgba(255,255,255,1);");const l=i.cloneNode(!0),o=i.cloneNode(!0),d=i.cloneNode(!0);e.appendChild(l),t.appendChild(o),r.appendChild(d)}})},selectedChanged:function(e){console.log("markers select",e),m=e.elems;for(var t=m.length,r=["line","path","polyline"];t--;){var n=m[t];a(n&&$.inArray(n.tagName,r)!==-1?e.selectedElement&&!e.multiselected?!0:!1:!1)}},elementChanged:function(e){var t=e.elems[0];if(t&&(t.getAttribute("marker-start")||t.getAttribute("marker-mid")||t.getAttribute("marker-end"))){o(t),d(t);var r=["line","path","polyline"];t&&$.inArray(t.tagName,r)!==-1&&a(!0)}}}})};